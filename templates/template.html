<!--  --><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Тестовое задание</title>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript" src="static/vis.js"></script>
    <link type="text/css" rel="stylesheet" href="static/style.css" />
</head>
<body>
<div id="graph" align="center"></div>

<div id="form">
    <form id="form_data" enctype="multipart/form-data" method="post">
        <div>
            <label for="image_uploads">Выберете файлы .xls, .xlsx</label>
            <input type="file" id="image_uploads" name="image_uploads" accept=".xls, .xlsx">
        </div>
        <div class="preview">
            <p>Нет выбранных файлов</p>
        </div>
    </form>
</div>
<div id="history">
    <p id="hist" align="center">История загрузки: (загружено {{ hist|length }}) </p>
    <ul>
        {% for elem in hist %}
            <li id="{{elem[0]}}">{{ elem[1] }} {{ elem[2] }}</li>
        {% endfor %}
    </ul>
</div>
<script>
    function get_data(id)
    {
        $.getJSON("/graph", {'id' : id},
            function(data){
                var container = $('#graph')[0];
                if (jQuery.isEmptyObject(data)) {
                    container.text('Нет информации в базе данных!');
                } else {
                    var network = new vis.Network(container, {}, {} );
                    network.setData(data)
                }
            }
        );
    }

    function update_event()
    {
        $('ul li').click(
            function() {
                get_data($(this).attr('id'));

                var elements = $('ul li');
                for (var i = 0; i< elements.length; i++) {
                   elements[i].style  = "";
                }

                this.style = "background-color: red;"
            }
        );
    }


    $(document).ready(function() {
        update_event();

        var elements = $('ul li');
        if(elements.length > 0)
        {
            elements[elements.length - 1].click();
        }

        var input = document.querySelector('input');
        var preview = document.querySelector('.preview');
        input.style.visibility = 'hidden';

        input.addEventListener('change', function() {
            var curFiles = input.files;

            if(curFiles.length === 0) {
                preview.children[0].textContent = 'Файл не выбран';
                return;
            }

            var file = curFiles[0];

            if (file.size > 1024*1024) {
                preview.children[0].textContent = 'Размер файла <' + file.name + '> превышает 1 МБ';
                return;
            }

            preview.children[0].textContent = 'Загружаем файла <' + file.name + '> ...';

            var formData = new FormData();
            formData.append("file", file);

            var request = new XMLHttpRequest();
            request.open("POST", "/upload");
            request.send(formData);
            request.onreadystatechange = function() {
                if (this.status == 200 && this.readyState == 4) {
                    preview.children[0].textContent = 'Файл <' + file.name + '> успешно загружен';
                    $("form")[0].reset();

                    var request = new XMLHttpRequest();
                    request.open("GET", "/id", true);
                    request.send();
                    request.onreadystatechange = function() {
                        if (this.status == 200 && this.readyState == 4) {
                            $('ul').prepend(this.responseText);
                            $('#hist')[0].textContent = 'История загрузки: (загружено ' + $('ul li').length + ')'
                            update_event();
                            get_data( $('ul li')[0].id);
                        }
                    }
                }
                else {
                    preview.children[0].textContent = 'Файл <' + file.name + '> не загружен';
                }
            }

        });
    });
</script>
</body>
</html>
